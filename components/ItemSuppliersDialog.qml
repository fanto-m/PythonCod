// components/ItemSuppliersDialog.qml
import QtQuick
import QtQuick.Controls
import QtQuick.Layouts

Dialog {
    id: itemSuppliersDialog
    title: "–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ —Ç–æ–≤–∞—Ä–∞"
    modal: true
    width: 550
    height: 550

    property string currentArticle: ""
    property int supplierCount: 0

    // –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
    ColumnLayout {
        anchors.fill: parent
        anchors.margins: 15
        spacing: 15

        // --- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å ---
        Rectangle {
            Layout.fillWidth: true
            Layout.preferredHeight: 50
            color: "#f8f9fa"
            border.color: "#dee2e6"
            border.width: 1
            radius: 4

            RowLayout {
                anchors.fill: parent
                anchors.margins: 10
                spacing: 10

                Text {
                    text: "üì¶"
                    font.pixelSize: 24
                }

                ColumnLayout {
                    spacing: 2
                    Layout.fillWidth: true

                    Label {
                        text: "–ê—Ä—Ç–∏–∫—É–ª: " + currentArticle
                        font.bold: true
                        font.pointSize: 11
                    }
                    Label {
                        text: "–ü–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤: " + supplierCount
                        font.pointSize: 10
                        color: "#6c757d"
                    }
                }
            }
        }

        // --- ComboBox –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ ---
        RowLayout {
            Layout.fillWidth: true
            spacing: 10
            visible: supplierCount > 0

            Label {
                text: "–í—ã–±–µ—Ä–∏—Ç–µ\n–ø–æ—Å—Ç–∞–≤—â–∏–∫–∞:"
                font.bold: true
                Layout.preferredWidth: 150
                horizontalAlignment: Text.AlignLeft
                verticalAlignment: Text.AlignVCenter
            }

            ComboBox {
                id: supplierComboBox
                Layout.fillWidth: true
                model: itemSuppliersModel
                textRole: "company"

                background: Rectangle {
                    color: "white"
                    border.color: supplierComboBox.pressed ? "#007bff" : "#ced4da"
                    border.width: 1
                    radius: 4
                }

                onCurrentIndexChanged: {
                    updateSupplierDetails()
                }

                delegate: ItemDelegate {
                    width: supplierComboBox.width
                    contentItem: Text {
                        text: {
                            var companyText = model.company || "–ù–µ —É–∫–∞–∑–∞–Ω–∞"
                            var nameText = model.name || ""
                            return nameText ? (companyText + " - " + nameText) : companyText
                        }
                        verticalAlignment: Text.AlignVCenter
                        elide: Text.ElideRight
                        font.pixelSize: 12
                    }
                    highlighted: supplierComboBox.highlightedIndex === index
                }

                displayText: {
                    if (currentIndex >= 0 && supplierCount > 0) {
                        var supplier = itemSuppliersModel.get(currentIndex)
                        return supplier.company || "–ù–µ —É–∫–∞–∑–∞–Ω–∞"
                    }
                    return "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞"
                }
            }
        }

        // --- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–æ—Å—Ç–∞–≤—â–∏–∫–µ ---
        Rectangle {
            Layout.fillWidth: true
            Layout.fillHeight: true
            color: "white"
            border.color: "#dee2e6"
            border.width: 1
            radius: 4
            visible: supplierCount > 0

            ScrollView {
                anchors.fill: parent
                anchors.margins: 15
                clip: true

                GridLayout {
                    width: parent.width
                    columns: 2
                    columnSpacing: 15
                    rowSpacing: 12

                    // ID
                    Label {
                        text: "ID:"
                        font.bold: true
                        font.pixelSize: 14
                        color: "#495057"
                    }
                    Label {
                        id: idLabel
                        text: "-"
                        Layout.fillWidth: true
                        font.pixelSize: 14
                    }

                    // –§–ò–û
                    Label {
                        text: "–§–ò–û:"
                        font.bold: true
                        font.pixelSize: 14
                        color: "#495057"
                    }
                    Label {
                        id: nameLabel
                        text: "-"
                        Layout.fillWidth: true
                        wrapMode: Text.WordWrap
                        font.pixelSize: 14
                    }

                    // –ö–æ–º–ø–∞–Ω–∏—è
                    Label {
                        text: "–ö–æ–º–ø–∞–Ω–∏—è:"
                        font.bold: true
                        font.pixelSize: 14
                        color: "#495057"
                    }
                    Label {
                        id: companyLabel
                        text: "-"
                        Layout.fillWidth: true
                        wrapMode: Text.WordWrap
                        font.pixelSize: 14
                        font.bold: true
                    }

                    // Email
                    Label {
                        text: "Email:"
                        font.bold: true
                        font.pixelSize: 14
                        color: "#495057"
                    }
                    Label {
                        id: emailLabel
                        text: "-"
                        Layout.fillWidth: true
                        font.pixelSize: 14
                        color: (emailLabel.text !== "-" && emailLabel.text !== "") ? "#007bff" : "black"
                        font.underline: emailLabel.text !== "-" && emailLabel.text !== ""

                        MouseArea {
                            anchors.fill: parent
                            cursorShape: (emailLabel.text !== "-" && emailLabel.text !== "") ? Qt.PointingHandCursor : Qt.ArrowCursor
                            enabled: emailLabel.text !== "-" && emailLabel.text !== ""
                            hoverEnabled: true
                            onEntered: {
                                if (enabled) emailLabel.color = "#0056b3"
                            }
                            onExited: {
                                if (enabled) emailLabel.color = "#007bff"
                            }
                            onClicked: {
                                if (emailLabel.text !== "-" && emailLabel.text !== "") {
                                    Qt.openUrlExternally("mailto:" + emailLabel.text)
                                }
                            }
                        }
                    }

                    // –¢–µ–ª–µ—Ñ–æ–Ω
                    Label {
                        text: "–¢–µ–ª–µ—Ñ–æ–Ω:"
                        font.bold: true
                        font.pixelSize: 14
                        color: "#495057"
                    }
                    Label {
                        id: phoneLabel
                        text: "-"
                        Layout.fillWidth: true
                        font.pixelSize: 14
                        color: (phoneLabel.text !== "-" && phoneLabel.text !== "") ? "#007bff" : "black"
                        font.underline: phoneLabel.text !== "-" && phoneLabel.text !== ""

                        MouseArea {
                            anchors.fill: parent
                            cursorShape: (phoneLabel.text !== "-" && phoneLabel.text !== "") ? Qt.PointingHandCursor : Qt.ArrowCursor
                            enabled: phoneLabel.text !== "-" && phoneLabel.text !== ""
                            hoverEnabled: true
                            onEntered: {
                                if (enabled) phoneLabel.color = "#0056b3"
                            }
                            onExited: {
                                if (enabled) phoneLabel.color = "#007bff"
                            }
                            onClicked: {
                                if (phoneLabel.text !== "-" && phoneLabel.text !== "") {
                                    Qt.openUrlExternally("tel:" + phoneLabel.text)
                                }
                            }
                        }
                    }

                    // –°–∞–π—Ç
                    Label {
                        text: "–°–∞–π—Ç:"
                        font.bold: true
                        font.pixelSize: 14
                        color: "#495057"
                    }
                    Label {
                        id: websiteLabel
                        text: "-"
                        Layout.fillWidth: true
                        wrapMode: Text.WrapAnywhere
                        font.pixelSize: 14
                        color: {
                            var hasWebsite = websiteLabel.text !== "-" && websiteLabel.text.trim() !== ""
                            return hasWebsite ? "#007bff" : "black"
                        }
                        font.underline: websiteLabel.text !== "-" && websiteLabel.text.trim() !== ""

                        MouseArea {
                            anchors.fill: parent
                            cursorShape: {
                                var hasWebsite = websiteLabel.text !== "-" && websiteLabel.text.trim() !== ""
                                return hasWebsite ? Qt.PointingHandCursor : Qt.ArrowCursor
                            }
                            hoverEnabled: true
                            onEntered: {
                                var hasWebsite = websiteLabel.text !== "-" && websiteLabel.text.trim() !== ""
                                if (hasWebsite) websiteLabel.color = "#0056b3"
                            }
                            onExited: {
                                var hasWebsite = websiteLabel.text !== "-" && websiteLabel.text.trim() !== ""
                                if (hasWebsite) websiteLabel.color = "#007bff"
                            }
                            onClicked: {
                                var urlText = websiteLabel.text.trim()
                                if (urlText !== "-" && urlText !== "") {
                                    var url = urlText
                                    if (!url.startsWith("http://") && !url.startsWith("https://")) {
                                        url = "https://" + url
                                    }
                                    console.log("Opening URL:", url)
                                    Qt.openUrlExternally(url)
                                }
                            }
                        }
                    }
                }
            }
        }

        // --- –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ ---
        Rectangle {
            Layout.fillWidth: true
            Layout.fillHeight: true
            color: "#f8f9fa"
            border.color: "#dee2e6"
            border.width: 1
            radius: 4
            visible: supplierCount === 0

            ColumnLayout {
                anchors.centerIn: parent
                spacing: 10

                Text {
                    text: "üì≠"
                    font.pixelSize: 48
                    Layout.alignment: Qt.AlignHCenter
                }

                Label {
                    text: "–ù–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤"
                    font.italic: true
                    font.pointSize: 12
                    color: "#6c757d"
                    Layout.alignment: Qt.AlignHCenter
                }
            }
        }
    }

    // –ö–Ω–æ–ø–∫–∏ –≤ footer
    footer: DialogButtonBox {
        Button {
            text: "–ó–∞–∫—Ä—ã—Ç—å"
            DialogButtonBox.buttonRole: DialogButtonBox.RejectRole

            background: Rectangle {
                color: parent.down ? "#e9ecef" : (parent.hovered ? "#f8f9fa" : "white")
                radius: 4
                border.color: "#ced4da"
                border.width: 1
            }

            contentItem: Text {
                text: parent.text
                font.pixelSize: 12
                color: "#495057"
                horizontalAlignment: Text.AlignHCenter
                verticalAlignment: Text.AlignVCenter
            }
        }
        onRejected: itemSuppliersDialog.close()
    }

    // --- –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π ---
    function updateSupplierDetails() {
        console.log("updateSupplierDetails called, currentIndex:", supplierComboBox.currentIndex, "count:", supplierCount)

        if (supplierComboBox.currentIndex >= 0 && supplierCount > 0) {
            var supplier = itemSuppliersModel.get(supplierComboBox.currentIndex)
            console.log("Supplier data:", JSON.stringify(supplier))

            idLabel.text = (supplier.id !== undefined && supplier.id !== null && supplier.id !== -1)
                ? String(supplier.id) : "-"
            nameLabel.text = supplier.name || "-"
            companyLabel.text = supplier.company || "-"
            emailLabel.text = supplier.email || "-"
            phoneLabel.text = supplier.phone || "-"
            websiteLabel.text = supplier.website || "-"
        } else {
            idLabel.text = "-"
            nameLabel.text = "-"
            companyLabel.text = "-"
            emailLabel.text = "-"
            phoneLabel.text = "-"
            websiteLabel.text = "-"
        }
    }

    // --- –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞ ---
    function openFor(article) {
        console.log("Opening suppliers dialog for article:", article)
        currentArticle = article

        itemSuppliersModel.setArticle(article)
        supplierUpdateTimer.restart()
        open()
    }

    // Timer to handle async model updates
    Timer {
        id: supplierUpdateTimer
        interval: 50
        repeat: false
        onTriggered: {
            supplierCount = itemSuppliersModel.rowCount()
            console.log("Supplier count updated:", supplierCount)

            if (supplierCount > 0) {
                supplierComboBox.currentIndex = 0
                updateSupplierDetails()
            }
        }
    }

    // Update count when dialog becomes visible
    onVisibleChanged: {
        if (visible) {
            supplierCount = itemSuppliersModel.rowCount()
            console.log("Dialog visible, supplier count:", supplierCount)
            if (supplierCount > 0) {
                updateSupplierDetails()
            }
        }
    }
}