# suppliers_table_model.py

Табличная модель данных для управления списком поставщиков в Qt/QML-приложении.

---

## Импорты

- `PySide6.QtCore`: Предоставляет базовые классы Qt (`QAbstractTableModel`, `Qt`, `Slot`, `Signal`).
- `database.DatabaseManager`: Менеджер для взаимодействия с базой данных.

---

## Класс `SuppliersTableModel`

Наследуется от `QAbstractTableModel`. Предназначен для предоставления данных о поставщиках в виде таблицы для QML-интерфейса, включая идентификатор, имя, компанию, email, телефон, веб-сайт и состояние флажка для выбора. Поддерживает загрузку данных, добавление, обновление, удаление и привязку поставщиков к товарам через `DatabaseManager`. Испускает сигнал `errorOccurred` при возникновении ошибок.

### Атрибуты ролей

| Роль             | Значение (Qt.UserRole + N) | Описание                     |
|------------------|----------------------------|------------------------------|
| `IdRole`         | `Qt.UserRole + 1`          | Идентификатор поставщика     |
| `NameRole`       | `Qt.UserRole + 2`          | Имя поставщика               |
| `CompanyRole`    | `Qt.UserRole + 3`          | Название компании            |
| `EmailRole`      | `Qt.UserRole + 4`          | Электронная почта            |
| `PhoneRole`      | `Qt.UserRole + 5`          | Телефон                      |
| `WebsiteRole`    | `Qt.UserRole + 6`          | Веб-сайт                     |
| `CheckStateRole` | `Qt.CheckStateRole`        | Состояние флажка (выбран/не выбран) |

### Сигналы

- **`errorOccurred(str)`**: Испускается при возникновении ошибок в методах изменения данных (добавление, обновление, удаление, привязка).

---

## Методы

### `__init__(self, parent=None)`

Инициализирует табличную модель поставщиков.

**Параметры:**  
- `parent (QObject, optional)`: Родительский объект Qt. По умолчанию `None`.

**Действия:**  
- Создает экземпляр `DatabaseManager` для работы с базой данных.  
- Инициализирует пустой список поставщиков и множество выбранных ID.  
- Вызывает `load` для загрузки данных.

---

### `load(self)`

Загружает всех поставщиков из базы данных для режима управления.  
Сбрасывает модель, загружает данные через `DatabaseManager`, преобразует идентификаторы в целые числа и очищает множество выбранных поставщиков.

---

### `loadForArticle(self, article)`

Загружает поставщиков с предварительно отмеченными флажками для режима привязки к товару.

**Параметры:**  
- `article (str)`: Артикул товара.

**Действия:**  
- Сбрасывает модель и загружает всех поставщиков.  
- Получает список ID поставщиков, привязанных к артикулу, и обновляет множество `_checked`.

---

### `roleNames(self)`

Возвращает сопоставление ролей и их строковых имен для QML.  
Используется QML для доступа к данным модели по именам (например, `model.name`).

**Возвращает:**  
- `dict`: Словарь вида `{роль: b"имя"}`, включая `CheckStateRole` для флажков.

---

### `columnCount(self, parent=None)`

Возвращает количество столбцов в таблице.

**Параметры:**  
- `parent (QModelIndex, optional)`: Родительский индекс (не используется). По умолчанию `None`.

**Возвращает:**  
- `int`: Количество столбцов (7: флажок, ID, ФИО, компания, email, телефон, сайт).

---

### `rowCount(self, parent=None)`

Возвращает количество строк в модели (число поставщиков).

**Параметры:**  
- `parent (QModelIndex, optional)`: Родительский индекс (не используется). По умолчанию `None`.

**Возвращает:**  
- `int`: Количество поставщиков в списке.

---

### `headerData(self, section, orientation, role=Qt.DisplayRole)`

Возвращает заголовки столбцов для табличного представления.

**Параметры:**  
- `section (int)`: Индекс столбца.
- `orientation (Qt.Orientation)`: Ориентация (горизонтальная или вертикальная).
- `role (int)`: Роль данных. По умолчанию `Qt.DisplayRole`.

**Возвращает:**  
- `str`: Заголовок столбца или `None`, если роль или индекс недействительны.

---

### `data(self, index, role=Qt.DisplayRole)`

Получает данные для указанного индекса и роли.

**Параметры:**  
- `index (QModelIndex)`: Индекс строки и столбца в модели.
- `role (int)`: Роль данных (например, `IdRole`, `NameRole`, `CheckStateRole`). По умолчанию `Qt.DisplayRole`.

**Возвращает:**  
- Значение, соответствующее роли, или `None`, если индекс недействителен.

---

### `setData(self, index, value, role=Qt.EditRole)`

Устанавливает данные для указанного индекса и роли.

**Параметры:**  
- `index (QModelIndex)`: Индекс строки и столбца в модели.
- `value`: Значение для установки (ожидается integer для `CheckStateRole`).
- `role (int)`: Роль данных. По умолчанию `Qt.EditRole`.

**Возвращает:**  
- `bool`: `True`, если данные успешно установлены, иначе `False`.

**Действия:**  
- Поддерживает только изменение состояния флажка (`CheckStateRole`).  
- Обновляет множество `_checked` и испускает сигнал `dataChanged`.

---

### `flags(self, index)`

Возвращает флаги для указанного индекса.

**Параметры:**  
- `index (QModelIndex)`: Индекс строки и столбца в модели.

**Возвращает:**  
- `Qt.ItemFlags`: Флаги, определяющие поведение элемента (выбираемый, включаемый, с флажком для первого столбца).

---

### `getSelectedSupplierIds(self)`

Возвращает список идентификаторов выбранных поставщиков.

**Возвращает:**  
- `list`: Список ID поставщиков, отмеченных флажками.

---

### `bindSuppliersToItem(self, article, supplier_ids)`

Привязывает список поставщиков к товару.

**Параметры:**  
- `article (str)`: Артикул товара.
- `supplier_ids (list)`: Список идентификаторов поставщиков.

**Действия:**  
- Преобразует идентификаторы в целые числа.  
- Вызывает метод `set_suppliers_for_item` в `DatabaseManager`.  
- Очищает множество `_checked` и обновляет состояние флажков.  
- При ошибке испускает сигнал `errorOccurred`.

---

### `getSupplierRow(self, row)`

Возвращает данные поставщика по указанной строке.

**Параметры:**  
- `row (int)`: Индекс строки в модели.

**Возвращает:**  
- `dict`: Словарь с данными поставщика (`id`, `name`, `company`, `email`, `phone`, `website`) или словарь с `id=-1`, если строка недействительна.

---

### `addSupplier(self, name, company, email, phone, website)`

Добавляет нового поставщика в базу данных.

**Параметры:**  
- `name (str)`: Имя поставщика.
- `company (str)`: Название компании.
- `email (str)`: Электронная почта.
- `phone (str)`: Телефон.
- `website (str)`: Веб-сайт.

**Действия:**  
- Вызывает метод `add_supplier` в `DatabaseManager`.  
- Перезагружает таблицу через `load`.  
- При ошибке испускает сигнал `errorOccurred`.

---

### `updateSupplier(self, supplier_id, name, company, email, phone, website)`

Обновляет данные существующего поставщика.

**Параметры:**  
- `supplier_id (int)`: Идентификатор поставщика.
- `name (str)`: Имя поставщика.
- `company (str)`: Название компании.
- `email (str)`: Электронная почта.
- `phone (str)`: Телефон.
- `website (str)`: Веб-сайт.

**Действия:**  
- Вызывает метод `update_supplier` в `DatabaseManager`.  
- Перезагружает таблицу через `load`.  
- При ошибке испускает сигнал `errorOccurred`.

---

### `deleteSupplier(self, supplier_id)`

Удаляет поставщика из базы данных.

**Параметры:**  
- `supplier_id (int)`: Идентификатор поставщика.

**Действия:**  
- Вызывает метод `delete_supplier` в `DatabaseManager`.  
- Перезагружает таблицу через `load`.  
- При ошибке испускает сигнал `errorOccurred`.